pipeline{
    agent any
    environment{
        PROJECT_PATH = "BankApp/BankApp/BankApp.csproj"
        BUILD_CONFIG = "Release"
        ARTIFACTS_DIR = "publish"
        REGISTRY_CREDENTIALS = "BankApp_accessKeys"
        ACCOUNT_ID = "322276017193"
        REGION = "us-east-1"
        IMAGE_NAME = "bankapprepo"
        ECR_REGISTRY = "322276017193.dkr.ecr.us-east-1.amazonaws.com"
        ECR_REGISTRY_URL = "https://322276017193.dkr.ecr.us-east-1.amazonaws.com"
        FULL_IMAGE = "322276017193.dkr.ecr.us-east-1.amazonaws.com/bankapprepo"
    }
    stages{
        stage("Checkout Code"){
            steps{
                   git url: 'https://github.com/YannickGongue/BankApp.git',
                       branch: 'main'
                }         
        }
        stage(" Check .Net Version"){
            steps{
                   sh "dotnet --version"
            }
        }
        stage("Restore Dependencies"){
            steps{
                   sh  ''' dotnet restore ${PROJECT_PATH} \
                           -p EnableWindowsTargeting=true 
                       '''
            }
        }
        stage("Build Application"){
            steps{
                   sh  ''' dotnet build ${PROJECT_PATH} -c ${BUILD_CONFIG} \
                            -p EnableWindowsTargeting=true 
                        '''
            }
        }
        stage("Run Test"){
            steps{
                    sh "echo 'No tests configured yet'"
            }
        }
        stage("Build Artifact"){
            steps{
                   sh '''
                        dotnet publish ${PROJECT_PATH} \
                             -c ${BUILD_CONFIG} \
                             -o ${ARTIFACTS_DIR} \
                             -p EnableWindowsTargeting=true
                      '''
            }
        }
        stage("archive Build output"){
            steps{
                   archiveArtifacts artifacts: "${ARTIFACTS_DIR}/**", allowEmptyArchive: false
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(
                        "${env.FULL_IMAGE}:${BUILD_NUMBER}",
                        "BankApp/Dockerfile"
                    )
                }
            }
        }
        stage('Upload App Image to ECR') {
          steps {
             script {
                   dockerImage.push("${BUILD_NUMBER}")
                  dockerImage.push("latest")
             }
          } 
        }
   
       stage('Remove Container Images'){
            steps{
                sh 'docker rmi -f $(docker images -a -q)'
            }
        }
        stage("Hello") {
            steps {
                sh 'echo "My first real Jenkins pipeline for .NET! üöÄ"'
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline SUCCESS"
        }
        failure {
            echo "‚ùå Pipeline FAILED"
        }
    }
    
}   
